package com.example.sendflow.service.impl;

import com.example.sendflow.config.RabbitConfig;
import com.example.sendflow.dto.MailMessageDto;
import com.example.sendflow.entity.*;
import com.example.sendflow.enums.CampaignStatus;
import com.example.sendflow.enums.EventStatus;
import com.example.sendflow.exception.ResourceNotFoundException;
import com.example.sendflow.repository.*;
import com.example.sendflow.service.ICampaignService;
import com.example.sendflow.service.ISmtpConfigService;
import lombok.RequiredArgsConstructor;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
@RequiredArgsConstructor
public class CampaignService implements ICampaignService {

    private final CampaignRepository campaignRepo;
    private final SendLogRepository sendLogRepo;
    private final RabbitTemplate rabbitTemplate;
    private final ISmtpConfigService smtpService;

    @Override
    public void sendCampaignMail(Long campaignId) {
        Campaign campaign = campaignRepo.findById(campaignId)
                .orElseThrow(() -> new ResourceNotFoundException("Campaign not found"));

        campaign.setStatus(CampaignStatus.SENDING);
        campaignRepo.save(campaign);

        List<Contact> contacts = campaign.getContactList().getContacts();
        SmtpConfig smtp = campaign.getUser().getSmtpConfig();

        for (Contact contact : contacts) {
            SendLog log = SendLog.builder()
                    .campaign(campaign)
                    .contact(contact)
                    .recipientEmail(contact.getEmail())
                    .status(EventStatus.NEW)
                    .build();
            sendLogRepo.save(log);

            MailMessageDto message = new MailMessageDto();
            message.setSendLogId(log.getId());
            message.setFromEmail(smtp.getUsername());
            message.setToEmail(contact.getEmail());
            message.setSubject(campaign.getSubject());
            message.setHtml(campaign.getMessageContent());
            message.setSmtpConfig(smtpService.getSmtpConfig(campaign.getUser()));

            rabbitTemplate.convertAndSend(RabbitConfig.MAIN_EXCHANGE, RabbitConfig.MAIL_ROUTING_KEY, message);
        }
    }
}
