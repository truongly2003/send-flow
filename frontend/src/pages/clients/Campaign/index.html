<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SendFlow — Demo Single Page</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#06b6d4;--ok:#10b981;--bad:#ef4444}
    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{margin:0;background:linear-gradient(180deg,#071026 0%, #071427 100%);color:#e6eef6}
    .wrap{max-width:1100px;margin:32px auto;padding:24px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
    .grid{display:grid;gap:12px}
    .row{display:flex;gap:12px}
    input, textarea, select{width:100%;padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#042027;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
    .layout{display:grid;grid-template-columns:360px 1fr;gap:12px}
    .contacts{max-height:260px;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
    .badge{padding:4px 8px;border-radius:999px;font-weight:600}
    .status-new{background:#0ea5a48a;color:#042027}
    .status-sent{background:rgba(16,185,129,0.12);color:var(--ok)}
    .status-failed{background:rgba(239,68,68,0.12);color:var(--bad)}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    .log{background:#03131a;padding:10px;border-radius:8px;max-height:160px;overflow:auto;font-family:monospace;font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>SendFlow — Demo (single page)</h1>
      <div class="small">Demo UI mô phỏng luồng: cấu hình SMTP → tạo contact → tạo campaign → gửi</div>
    </header>

    <div class="layout">
      <div class="card">
        <div style="margin-bottom:12px">
          <strong>1) Tài khoản & SMTP</strong>
          <div class="small">Nhập thông tin SMTP của user (lưu local demo).</div>
        </div>
        <div class="grid">
          <label>Email đăng nhập
            <input id="userEmail" placeholder="user@example.com" />
          </label>
          <label>SMTP host
            <input id="smtpHost" placeholder="smtp.gmail.com" />
          </label>
          <label>Port
            <input id="smtpPort" placeholder="587" />
          </label>
          <label>Username
            <input id="smtpUser" placeholder="user@example.com" />
          </label>
          <label>Password / App password (demo)
            <input id="smtpPass" placeholder="app-password" />
          </label>
          <div style="display:flex;gap:8px">
            <button id="saveSmtpBtn">Lưu SMTP (local)</button>
            <button id="testSmtpBtn" class="ghost">Test kết nối</button>
          </div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px dashed rgba(255,255,255,0.03)" />

        <div>
          <strong>2) Contact list</strong>
          <div class="small">Thêm email để gửi (CSV import mô phỏng bằng textarea).</div>
          <div style="margin-top:8px" class="grid">
            <label>Danh sách (mỗi email 1 dòng)
              <textarea id="contactsInput" rows="6" placeholder="a@a.com\nb@b.com"></textarea>
            </label>
            <div style="display:flex;gap:8px">
              <button id="importContacts">Import</button>
              <button id="clearContacts" class="ghost">Xóa</button>
            </div>
            <div class="contacts card" id="contactsCard"></div>
          </div>
        </div>
      </div>

      <div>
        <div class="card" style="margin-bottom:12px">
          <strong>3) Tạo chiến dịch</strong>
          <div class="small">Soạn nội dung & gửi. Demo sẽ tạo SendLog và giả lập worker gửi.</div>
          <div style="margin-top:8px" class="grid">
            <label>Tiêu đề
              <input id="campaignSubject" placeholder="Tiêu đề chiến dịch" />
            </label>
            <label>Nội dung HTML
              <textarea id="campaignHtml" rows="6"><p>Xin chào, đây là email thử nghiệm.</p></textarea>
            </label>
            <div style="display:flex;gap:8px">
              <button id="sendCampaign">Gửi chiến dịch</button>
              <button id="previewEmail" class="ghost">Preview email</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-bottom:12px">
          <strong>4) Send logs</strong>
          <div class="small">Bảng mô phỏng bảng send_log. Worker sẽ update trạng thái.</div>
          <div style="margin-top:8px;overflow:auto">
            <table id="sendLogTable">
              <thead>
                <tr><th>ID</th><th>Recipient</th><th>Subject</th><th>Status</th><th>Thời gian</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <strong>Console (demo)</strong>
          <div class="log" id="consoleLog"></div>
        </div>
      </div>
    </div>

    <footer class="small">Hướng dẫn: lưu file <code>sendflow-demo.html</code> và mở bằng trình duyệt. Đây là demo front-end — thay các chỗ có comment bằng API backend thực tế.</footer>
  </div>

  <script>
    // Simple demo state (localStorage based)
    const $ = id => document.getElementById(id);
    const logEl = $('consoleLog');
    const sendLogRows = [];
    let nextSendLogId = 1;

    function log(...args){
      const t = new Date().toLocaleTimeString();
      logEl.innerText = `[${t}] ` + args.join(' ') + '\n' + logEl.innerText;
    }

    // load smtp from localStorage
    function loadSmtp(){
      const raw = localStorage.getItem('demo_smtp');
      if(!raw) return null;
      try{ return JSON.parse(raw);}catch(e){return null}
    }
    function saveSmtp(obj){ localStorage.setItem('demo_smtp', JSON.stringify(obj)); }

    // Contacts
    let contacts = [];
    function renderContacts(){
      const c = $('contactsCard'); c.innerHTML = '';
      if(contacts.length===0){ c.innerHTML = '<div class="small">(Không có contact)</div>'; return }
      contacts.forEach((email,i)=>{
        const div = document.createElement('div');
        div.style.display='flex'; div.style.justifyContent='space-between'; div.style.margin='6px 0';
        div.innerHTML = `<div>${i+1}. ${email}</div><div><button data-i="${i}" class="ghost">X</button></div>`;
        c.appendChild(div);
      });
      c.querySelectorAll('button').forEach(btn=>btn.addEventListener('click',e=>{contacts.splice(+btn.dataset.i,1);renderContacts()}));
    }

    // Send log table
    function renderSendLogs(){
      const tbody = document.querySelector('#sendLogTable tbody'); tbody.innerHTML='';
      sendLogRows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.id}</td><td>${r.recipient}</td><td>${r.subject}</td><td><span class="badge ${r.status==='NEW'?'status-new':r.status==='SENT'?'status-sent':'status-failed'}">${r.status}</span></td><td>${r.time||''}</td>`;
        tbody.appendChild(tr);
      });
    }

    // Simulate worker: sends email using stored SMTP config
    function workerProcess(message){
      // message: MailMessageDto
      log('Worker nhận message', JSON.stringify(message));
      // simulate network latency
      setTimeout(()=>{
        const smtp = message.smtpConfig || loadSmtp();
        const row = sendLogRows.find(r=>r.id===message.sendLogId);
        if(!smtp || !smtp.username || !smtp.password){
          row.status='FAILED'; row.time=new Date().toLocaleString(); renderSendLogs();
          log('Worker: Không có cấu hình SMTP hợp lệ → GHI FAILED cho', message.toEmail);
          return;
        }
        // demo rule: nếu password === 'bad' sẽ fail
        if(smtp.password.trim().toLowerCase()==='bad'){
          row.status='FAILED'; row.time=new Date().toLocaleString(); renderSendLogs();
          log('Worker: SMTP auth failed (demo).');
          return;
        }
        // success
        row.status='SENT'; row.time=new Date().toLocaleString(); renderSendLogs();
        log('Worker: Gửi thành công →', message.toEmail);
      }, 800 + Math.random()*800);
    }

    // UI handlers
    $('saveSmtpBtn').addEventListener('click', ()=>{
      const obj = {
        host: $('smtpHost').value || 'smtp.gmail.com',
        port: Number($('smtpPort').value||587),
        username: $('smtpUser').value || $('userEmail').value || '',
        password: $('smtpPass').value || ''
      };
      saveSmtp(obj); log('Lưu SMTP (local):', obj.username); alert('Đã lưu (local demo).');
    });

    $('testSmtpBtn').addEventListener('click', ()=>{
      const smtp = loadSmtp();
      if(!smtp){ alert('Chưa có cấu hình SMTP - lưu trước rồi test.'); return }
      // fake test: pass nếu password không rỗng và != 'bad'
      setTimeout(()=>{
        if(!smtp.password) { alert('Test kết nối thất bại: password rỗng (demo)'); log('Test SMTP: password rỗng'); return }
        if(smtp.password.trim().toLowerCase()==='bad'){ alert('Test kết nối thất bại (demo): Bad credentials'); log('Test SMTP: bad credentials'); return }
        alert('Test kết nối thành công (demo)'); log('Test SMTP: success');
      },500);
    });

    $('importContacts').addEventListener('click', ()=>{
      const val = $('contactsInput').value.trim(); if(!val){alert('Chưa nhập email'); return}
      const lines = val.split(/[\r\n]+/).map(s=>s.trim()).filter(Boolean);
      contacts = contacts.concat(lines.filter(l=>!contacts.includes(l)));
      renderContacts();
      $('contactsInput').value='';
      log('Import contacts:', lines.length);
    });
    $('clearContacts').addEventListener('click', ()=>{contacts=[];renderContacts();log('Xóa contacts')});

    $('sendCampaign').addEventListener('click', ()=>{
      const subj = $('campaignSubject').value || '(no subject)';
      const html = $('campaignHtml').value || '';
      if(contacts.length===0){ alert('Danh sách rỗng'); return }
      // create send logs and push messages
      contacts.forEach(email=>{
        const id = nextSendLogId++;
        const row = {id, recipient: email, subject: subj, status: 'NEW', time: ''};
        sendLogRows.push(row); renderSendLogs();

        // build MailMessageDto
        const smtpConfig = loadSmtp();
        const message = { sendLogId: id, fromEmail: smtpConfig?smtpConfig.username:'system@example.com', toEmail: email, subject: subj, html, smtpConfig };
        // simulate rabbit send
        log('Producer gửi message vào RabbitMQ (demo):', JSON.stringify({sendLogId:id,toEmail:email,from:message.fromEmail}));
        // simulate consumer
        setTimeout(()=>workerProcess(message), 100);
      });
    });

    $('previewEmail').addEventListener('click', ()=>{
      const html = $('campaignHtml').value || '';
      const w = window.open(); w.document.write(html); w.document.title='Preview';
    });

    // initial render
    renderContacts(); renderSendLogs();
    // load saved smtp into form
    const saved = loadSmtp(); if(saved){ $('smtpHost').value=saved.host; $('smtpPort').value=saved.port; $('smtpUser').value=saved.username; $('smtpPass').value=saved.password; $('userEmail').value=saved.username }
  </script>
</body>
</html>









